name: Build VPM Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  packageName: "com.nakzi.avatarhelper"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.prop }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version from package.json
        id: version
        uses: notiz-dev/github-action-json-property@v0.2.0
        with:
          path: "package.json"
          prop_path: "version"

      - name: Set Environment Variables
        id: env
        run: |
          echo "zipFile=${{ env.packageName }}-${{ steps.version.outputs.prop }}.zip" >> $GITHUB_OUTPUT
          echo "zipFile=${{ env.packageName }}-${{ steps.version.outputs.prop }}.zip" >> $GITHUB_ENV

      - name: Create Package Zip
        run: |
          zip -r "${{ env.zipFile }}" . -x ".git/*" -x ".github/*" -x "website/*"

      - name: Upload Zip as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-zip
          path: ${{ env.zipFile }}

      - name: Upload Zip to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.zipFile }}

  update-listing:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version from package.json
        id: version
        uses: notiz-dev/github-action-json-property@v0.2.0
        with:
          path: "package.json"
          prop_path: "version"

      - name: Get Release Tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=v${{ steps.version.outputs.prop }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate VPM Listing
        run: |
          mkdir -p website
          
          VERSION="${{ steps.version.outputs.prop }}"
          TAG="${{ steps.tag.outputs.tag }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${{ env.packageName }}-${VERSION}.zip"
          
          # Read package.json
          PACKAGE_JSON=$(cat "package.json")
          
          # Create index.json using jq
          jq -n \
            --arg name "NAKZI Avatar Helper" \
            --arg id "com.nakzi.repos" \
            --arg url "https://${REPO_OWNER}.github.io/${REPO_NAME}/index.json" \
            --arg author "NAKZI-STAR" \
            --arg pkgName "${{ env.packageName }}" \
            --arg version "$VERSION" \
            --arg downloadUrl "$DOWNLOAD_URL" \
            --argjson pkgJson "$PACKAGE_JSON" \
            '{
              name: $name,
              id: $id,
              url: $url,
              author: $author,
              packages: {
                ($pkgName): {
                  versions: {
                    ($version): ($pkgJson + {url: $downloadUrl})
                  }
                }
              }
            }' > website/index.json
          
          echo "Generated index.json:"
          cat website/index.json

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: website

  deploy-pages:
    needs: update-listing
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

